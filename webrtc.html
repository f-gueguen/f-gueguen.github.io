<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebRTC</title>
</head>
<body>
    <h2>WebRTC Signaling</h2>

    <table width="100%" border="1">
        <tr>
            <th>#</th>
            <th>Initiator</th>
            <th>Receiver</th>
        </tr>
        <tr>
            <td>Step 1</td>
            <td>
                <button id="startButton">Create Offer</button>
                <textarea id="localSessionDescription" placeholder="Offer will be shown here" readonly></textarea>
            </td>
            <td></td>
        </tr>
        <tr>
            <td>Step 2</td>
            <td></td>
            <td>
                <textarea id="remoteOfferDescription" placeholder="Paste offer from Initiator here"></textarea>
                <button id="createAnswerButton">Create Answer</button>
                <textarea id="localAnswerDescription" placeholder="Answer will be shown here" readonly></textarea>
            </td>
        </tr>
        <tr>
            <td>Step 3</td>
            <td>
                <textarea id="remoteAnswerDescription" placeholder="Paste answer from Receiver here"></textarea>
                <button id="connectButton">Connect</button>
            </td>
            <td></td>
        </tr>
    </table>

    <hr>
    <h2>Status</h2>
    <table border="1">
        <tr>
            <th>Connection State</th>
            <td id="connectionState">Unknown</td>
        </tr>
        <tr>
            <th>ICE Connection State</th>
            <td id="iceConnectionState">Unknown</td>
        </tr>
    </table>

    <hr>
    <h2>Chat</h2>
    <input id="messageInput" type="text" placeholder="Enter message">
    <button id="sendMessageButton">Send Message</button>
    <ul id="messages"></ul>

    <script>
        let localPeerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        let dataChannel;
        let iceCandidates = [];

        const startButton = document.getElementById('startButton');
        const createAnswerButton = document.getElementById('createAnswerButton');
        const connectButton = document.getElementById('connectButton');
        const sendMessageButton = document.getElementById('sendMessageButton');

        const localSessionDescriptionTextArea = document.getElementById('localSessionDescription');
        const remoteOfferDescriptionTextArea = document.getElementById('remoteOfferDescription');
        const localAnswerDescriptionTextArea = document.getElementById('localAnswerDescription');
        const remoteAnswerDescriptionTextArea = document.getElementById('remoteAnswerDescription');

        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');
        const connectionStateElement = document.getElementById('connectionState');
        const iceConnectionStateElement = document.getElementById('iceConnectionState');

        startButton.addEventListener('click', start);
        createAnswerButton.addEventListener('click', createAnswer);
        connectButton.addEventListener('click', connect);
        sendMessageButton.addEventListener('click', sendMessage);

        async function start() {
            // Create a data channel
            dataChannel = localPeerConnection.createDataChannel('chat');
            setupDataChannel();

            // Display connection states
            localPeerConnection.onconnectionstatechange = handleConnectionStateChange;
            localPeerConnection.oniceconnectionstatechange = handleIceConnectionStateChange;

            // Handle ICE candidates
            localPeerConnection.onicecandidate = handleIceCandidate;

            const offer = await localPeerConnection.createOffer();
            await localPeerConnection.setLocalDescription(offer);
        }

        async function createAnswer() {
            const remoteOffer = JSON.parse(remoteOfferDescriptionTextArea.value);
            await localPeerConnection.setRemoteDescription(new RTCSessionDescription(remoteOffer));

            localPeerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel();
            };

            const answer = await localPeerConnection.createAnswer();
            await localPeerConnection.setLocalDescription(answer);

            localAnswerDescriptionTextArea.value = JSON.stringify(localPeerConnection.localDescription);
        }

        async function connect() {
            const remoteAnswer = JSON.parse(remoteAnswerDescriptionTextArea.value);
            await localPeerConnection.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
        }

        function sendMessage() {
            const message = messageInput.value;
            dataChannel.send(message);
            addMessageToList('Sent: ' + message);
            messageInput.value = '';
        }

        function setupDataChannel() {
            dataChannel.onmessage = handleDataChannelMessage;
            dataChannel.onopen = handleDataChannelOpen;
            dataChannel.onclose = handleDataChannelClose;
        }

        function handleIceCandidate(event) {
            if (event.candidate) {
                iceCandidates.push(event.candidate.toJSON());
            } else {
                localSessionDescriptionTextArea.value = JSON.stringify({ ...localPeerConnection.localDescription.toJSON(), iceCandidates });
            }
        }

        function handleDataChannelMessage(event) {
            addMessageToList('Received: ' + event.data);
        }

        function handleDataChannelOpen() {
            sendMessageButton.disabled = false;
            addMessageToList('Data Channel Opened');
        }

        function handleDataChannelClose() {
            sendMessageButton.disabled = true;
            addMessageToList('Data Channel Closed');
        }

        function handleConnectionStateChange() {
            connectionStateElement.textContent = capitalize(localPeerConnection.connectionState);
        }

        function handleIceConnectionStateChange() {
            iceConnectionStateElement.textContent = capitalize(localPeerConnection.iceConnectionState);
        }

        function addMessageToList(message) {
            const li = document.createElement('li');
            li.textContent = message;
            messages.appendChild(li);
        }

        function capitalize(s) {
            if (typeof s !== 'string') return '';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }
    </script>
</body>
</html>
